<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>View Staff Mappings - Feedback App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <style>
        body {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }
        header {
            background: linear-gradient(90deg, #0062cc 0%, #007bff 100%);
            color: #fff;
            padding: 20px;
            text-align: center;
            width: 100%;
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            font-weight: bold;
            margin: 0 0 5px 0;
            font-size: 2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        .college-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        .main-content {
            margin-top: 140px;
            padding: 20px;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: calc(100vh - 140px);
        }
        .content-box {
            background: rgba(227, 235, 245, 0.9);
            border: 2px solid #007bff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 1400px;
            position: relative;
            transition: all 0.3s ease;
        }
        .btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            margin: 0.5rem;
            border-radius: 30px;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .table thead {
            background: linear-gradient(90deg, #0062cc 0%, #007bff 100%);
            color: white;
        }
        .table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            border: none;
        }
        .table td {
            vertical-align: middle;
            border-color: #e9ecef;
        }
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <header>
        <div class="college-name">VSB ENGINEERING COLLEGE</div>
        <h1>View & Delete Staff Mappings</h1>
    </header>
    
    <div class="main-content container-fluid">
        <div class="content-box">
            <div id="flashMessages"></div>
            
            <!-- Filter Section -->
            <div class="filter-section">
                <h4 class="text-primary mb-3"><i class="fas fa-filter mr-2"></i>Filter Mappings</h4>
                <div class="form-row">
                    <div class="col-md-4">
                        <label>Department:</label>
                        <select class="form-control" id="filterDepartment">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                                <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Semester:</label>
                        <select class="form-control" id="filterSemester">
                            <option value="">All Semesters</option>
                            {% for sem in semesters %}
                                <option value="{{ sem }}">{{ sem }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>&nbsp;</label><br>
                        <button class="btn btn-primary" id="filterBtn">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                        <button class="btn btn-secondary" id="clearBtn">
                            <i class="fas fa-times mr-2"></i>Clear
                        </button>
                    </div>
                </div>
                <div class="mt-3" id="deleteAllSection" style="display: none;">
                    <button class="btn btn-danger btn-sm" id="deleteAllBtn">
                        <i class="fas fa-trash-alt mr-2"></i>Delete All Mappings for Selected Dept/Sem
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection">
                <h4 class="text-primary mb-3">
                    <i class="fas fa-list mr-2"></i>Mappings 
                    <span class="badge badge-info" id="mappingCount">0</span>
                </h4>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="mappingsTable">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="25%">Department</th>
                                <th width="10%">Semester</th>
                                <th width="25%">Staff</th>
                                <th width="25%">Subject</th>
                                <th width="10%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="mappingsBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-info-circle mr-2"></i>Select filters and click Filter to view mappings
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-4 text-right">
                <a href="{{ url_for('admin.admin') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Mapping Page
                </a>
            </div>
        </div>
    </div>

    <div class="copyright-footer">
        This site is Created and Managed by GenrecAI<br>
        <a href="https://revolvo-ai.netlify.app" target="_blank">Genrec.AI</a>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function() {
            function loadMappings() {
                const department = $('#filterDepartment').val();
                const semester = $('#filterSemester').val();

                $('#mappingsBody').html(`
                    <tr>
                        <td colspan="6" class="text-center">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                        </td>
                    </tr>
                `);

                $.ajax({
                    url: '/admin/mappings/list',
                    method: 'GET',
                    data: { department, semester },
                    success: function(response) {
                        if (response.success) {
                            $('#mappingCount').text(response.count);
                            
                            if (response.mappings.length === 0) {
                                $('#mappingsBody').html(`
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="fas fa-inbox mr-2"></i>No mappings found
                                        </td>
                                    </tr>
                                `);
                                $('#deleteAllSection').hide();
                            } else {
                                let html = '';
                                response.mappings.forEach((mapping, index) => {
                                    html += `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${escapeHtml(mapping.department)}</td>
                                            <td>${escapeHtml(mapping.semester)}</td>
                                            <td>${escapeHtml(mapping.staff)}</td>
                                            <td>${escapeHtml(mapping.subject)}</td>
                                            <td>
                                                <button class="btn btn-danger btn-sm delete-btn" data-id="${mapping.id}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                });
                                $('#mappingsBody').html(html);
                                
                                if (department && semester) {
                                    $('#deleteAllSection').show();
                                }
                            }
                        }
                    },
                    error: function() {
                        $('#flashMessages').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle mr-2"></i>Error loading mappings
                            </div>
                        `);
                    }
                });
            }

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            $('#filterBtn').on('click', function() {
                loadMappings();
            });

            $('#clearBtn').on('click', function() {
                $('#filterDepartment').val('');
                $('#filterSemester').val('');
                $('#mappingsBody').html(`
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-info-circle mr-2"></i>Select filters and click Filter to view mappings
                        </td>
                    </tr>
                `);
                $('#mappingCount').text('0');
                $('#deleteAllSection').hide();
            });

            $(document).on('click', '.delete-btn', function() {
                if (!confirm('Are you sure you want to delete this mapping?')) {
                    return;
                }

                const btn = $(this);
                const mappingId = btn.data('id');
                btn.html('<i class="fas fa-spinner fa-spin"></i>');
                btn.prop('disabled', true);

                $.ajax({
                    url: '/admin/mappings/delete',
                    method: 'POST',
                    data: { mapping_id: mappingId },
                    success: function(response) {
                        if (response.success) {
                            $('#flashMessages').html(`
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle mr-2"></i>${response.message}
                                </div>
                            `);
                            loadMappings();
                            setTimeout(() => {
                                $('#flashMessages .alert').fadeOut();
                            }, 3000);
                        } else {
                            alert(response.message);
                            btn.html('<i class="fas fa-trash"></i>');
                            btn.prop('disabled', false);
                        }
                    },
                    error: function() {
                        alert('Error deleting mapping');
                        btn.html('<i class="fas fa-trash"></i>');
                        btn.prop('disabled', false);
                    }
                });
            });

            $('#deleteAllBtn').on('click', function() {
                const department = $('#filterDepartment').val();
                const semester = $('#filterSemester').val();

                if (!department || !semester) {
                    alert('Please select both department and semester');
                    return;
                }

                if (!confirm(`Are you sure you want to delete ALL mappings for ${department} - Semester ${semester}?`)) {
                    return;
                }

                const btn = $(this);
                btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...');
                btn.prop('disabled', true);

                $.ajax({
                    url: '/admin/mappings/delete-all',
                    method: 'POST',
                    data: { department, semester },
                    success: function(response) {
                        if (response.success) {
                            $('#flashMessages').html(`
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle mr-2"></i>${response.message}
                                </div>
                            `);
                            loadMappings();
                            setTimeout(() => {
                                $('#flashMessages .alert').fadeOut();
                            }, 3000);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert('Error deleting mappings');
                    },
                    complete: function() {
                        btn.html('<i class="fas fa-trash-alt mr-2"></i>Delete All Mappings for Selected Dept/Sem');
                        btn.prop('disabled', false);
                    }
                });
            });
        });
    </script>
</body>
</html>
